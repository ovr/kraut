<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>
<body>

<script src="matrix.js"></script>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]}
  });

</script>
<script src="bower_components/MathJax/MathJax.js"></script>

<style type="text/css">
    .not-valid {
        border: 1px solid red;
    }

    form {
        text-align: center;
        padding-top: 50px;
    }

    #calc {
        margin: 0 auto;
    }

    #result {
        width: 650px;
        margin: 0 auto;
        text-align: center;
    }
</style>

<script>
    $(document).ready(function () {
        console.log("ready!");

        function printTable($selector, size, old) {
            $selector.html('');
            var value;

            for (i = 0; i < size; i++) {
                row = $('<tr>');

                for (j = 0; j < size; j++) {
                    value = '';

                    if (old[i] != undefined) {
                        if (old[i][j] != undefined && !isNaN(old[i][j])) {
                            value = old[i][j];
                        }
                    }

                    row.append(
                            $('<td>').html(
                                    $('<input>').attr({
                                        value: value,
                                        type: "text",
                                        name: "matrix[][]"
                                    })
                            )
                    );
                }

                $selector.append(row);
            }
        }

        MATRIX_DEFAULT_SIZE = 4;

        $table = $('#calc');
        printTable($table, MATRIX_DEFAULT_SIZE, [[3, 1, -1, 2], [-5, 1, 3, -4], [2, 0, 1, -1], [1, -5, 3, -3]]);
        //5 #3# 1
//        printTable($table, MATRIX_DEFAULT_SIZE, [[1,2,4],[5,3,1],[2,4,2]]);
//        printTable($table, MATRIX_DEFAULT_SIZE, [[1,2,4],[5,6,1],[2,4,2]]);


        function parseMatrix() {
            var matrix = [];
            $('#calc tr').each(function () {
                var elements = $('td');

                var arrElementsRow = [];
                $(this).find('td input').each(function (element) {
                    arrElementsRow.push(parseFloat($(this).val()));
                });

                matrix.push(arrElementsRow);
            });

            return matrix;
        }


        var $minusMatrixRow = $('#minusMatrixRow');

        $('#plusMatrixRow').click(function (e) {
            event.preventDefault();

            if (MATRIX_DEFAULT_SIZE == 2) {
                $minusMatrixRow.removeAttr('disabled');
            }

            MATRIX_DEFAULT_SIZE++;
            printTable($table, MATRIX_DEFAULT_SIZE, parseMatrix());
        });

        $minusMatrixRow.click(function (e) {
            event.preventDefault();

            if (MATRIX_DEFAULT_SIZE == 3) {
                $minusMatrixRow.attr('disabled', 'true');
            }

            MATRIX_DEFAULT_SIZE--;
            printTable($table, MATRIX_DEFAULT_SIZE, parseMatrix());
        });

        function buildStrMatrix(data) {
            var str = '\\begin{bmatrix} ';


            for (i = 0; i < data.length; i++) {
                for (j = 0; j < data.length; j++) {
                    str += data[i][j];

                    if (j + 1 < data.length) {
                        str += ' & ';
                    }
                }

                if (i + 1 < data.length) {
                    str += "\\\\ ";
                }
            }

            return str + ' \\end{bmatrix}';
        }

        function kraut(A) {
            var L = [];
            var U = [];

            var tmp = [];
            for (j = 0; j < A.length; j++) {
                tmp.push(0);
            }

            for (i = 0; i < A.length; i++) {
                L.push(tmp.slice());
                U.push(tmp.slice());
            }

            var n = A.length;
            var i, j, sum, k;

            //U миноры = 1
            for (i = 0; i < n; i++) {
                U[i][i] = 1;
            }


            //1 столбец
            for (i = 0; i < n; i++) {
                L[i][0] = A[i][0];
            }

            $result.append('\\[ ');
            $result.append("L = " + buildStrMatrix(L));
            $result.append("U = " + buildStrMatrix(U));
            $result.append('\\]');
//
//                L[0][0]=A[0][0];
//                L[1][0]=A[1][0];
//                L[2][0]=A[2][0];


//            //u12
//            U[0][1]=A[0][1]/L[0][0];
//            //u13
//            U[0][2]=A[0][2]/L[0][0];
//
//            L[1][1]=A[1][1]-L[1][0]*U[0][1];
//            L[2][1]=A[2][1]-L[2][0]*U[0][1];
//
//            //u23
//            U[1][2]=(A[1][2]-L[1][0]*U[0][2])/L[1][1];
//
//            //l33
//            L[2][2]=A[2][2]-(L[2][0]*U[0][2]+L[2][1]*U[1][2]);

            var m;
            k = 0;
            var go, print;

            while (k < n) {
                console.log("K = " + k);


                //0 1 2
                //U[0][1]=A[0][1]/L[0][0];
                //U[0][2]=A[0][2]/L[0][0];
                //U[1][2]=(A[1][2]-L[1][0]*U[0][2])/L[1][1];

                print = false;

                for (j = 0; j < n; j++) {
                    if (j > k) {
                        console.log("U[" + k + "][" + j + "] = ");

                        sum = 0;
                        tmp = '';
                        go = false;

                        for (m = 0; m < k; m++) {
                            go = true;
                            tmp += L[k][m] + ' * ' + U[m][j];
                            sum += L[k][m] * U[m][j];
                        }

                        if (go) {
                            tmp = '-(' + tmp + ')';
                        }


                        U[k][j] = (A[k][j] - sum) / L[k][k];
                        U[k][j] = Math.round(U[k][j]*10000)/10000;

                        print = true;
                        $result.append('\\[ U[' + k + '][' + j + '] = (' + A[k][j] + tmp + ')/' + L[k][k] + ' = ' + U[k][j] + '\\]');
                    }
                }

                if (print) {
                    $result.append('\\[ ');
                    $result.append("U = " + buildStrMatrix(U));
                    $result.append('\\]');
                }

                k++;

                print = false;
                console.log("K = " + k);

                for (i = 0; i < n; i++) {
                    if (i >= k) {
                        print = true;
                        console.log("L[" + i + "][" + k + "] = ");

                        sum = 0;
                        tmp = '';
                        go = false;

                        for (m = 0; m < k; m++) {
                            go = true;
                            tmp += L[i][m] + ' * ' + U[m][k];
                            sum += L[i][m] * U[m][k];
                        }


                        if (go) {
                            tmp = '-(' + tmp + ')';
                        }

                        L[i][k] = A[i][k] - sum;
                        L[i][k] = Math.round(L[i][k]*10000)/10000;

                        $result.append('\\[ L[' + i + '][' + k + '] = (' + A[i][k] + tmp + ') = ' + L[i][k] + '\\]');
                    }
                }

                if (print) {
                    $result.append('\\[ ');
                    $result.append("L = " + buildStrMatrix(L));
                    $result.append('\\]');
                }
            }

            return [L, U];
        }

        var $result = $('#result');

        $('#calculate').click(function (e) {
            e.preventDefault();
            $result.html('');

            console.log("Calculate");

            var matrix = [];
            var isValid = true;

            $('#calc tr').each(function () {
                var elements = $('td');

                var arrElementsRow = [];
                $(this).find('td input').each(function (element) {
                    var $element = $(this);

                    if ($element.val() == "") {
                        $element.addClass('not-valid');
                        isValid = false;
                    } else {
                        $element.removeClass('not-valid');
                    }

                    arrElementsRow.push(parseFloat($element.val()));
                });

                matrix.push(arrElementsRow);
            });


            if (isValid) {
                $result.append("\\[A = " + buildStrMatrix(matrix) + "\\]");

                $result.append('\\[A = L * U\\]');

//                $result.append('<a href="#">Показать решение</a>');
//                $result.append('<div style="display: none;">');
                var result = kraut(matrix);
                var L = result[0];
                var U = result[1];
//                $result.append('</div>');

                $result.append('\\[ ');
                $result.append("L = " + buildStrMatrix(L));
                $result.append("U = " + buildStrMatrix(U));
                $result.append('\\]');

                MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
            } else {

            }
        });
        $('#calculate').click();
    });
</script>

<form>
    <button id="plusMatrixRow">+1</button>
    <button id="minusMatrixRow">-1</button>
    <table id="calc"></table>
    <button id="calculate">Посчитать</button>
    <div id="result">

    </div>
</form>

</body>
</html>